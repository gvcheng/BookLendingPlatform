<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booklending.mapper.ReservationMapper">
<resultMap id="ReservationResultMap" type="com.booklending.entity.Reservation">
<id property="id" column="id"/>
<result property="userId" column="user_id"/>
<result property="bookId" column="book_id"/>
<result property="reservationDate" column="reservation_date"/>
<result property="expirationDate" column="expiration_date"/>
<result property="status" column="status"/>
<result property="priority" column="priority"/>
<result property="createdAt" column="created_at"/>
<result property="updatedAt" column="updated_at"/>
</resultMap>

<insert id="insert" parameterType="com.booklending.entity.Reservation">
INSERT INTO reservation (user_id, book_id, reservation_date, expiration_date, status, priority, created_at, updated_at)
VALUES (#{userId}, #{bookId}, #{reservationDate}, #{expirationDate}, #{status}, #{priority}, #{createdAt}, #{updatedAt})
</insert>

<update id="update" parameterType="com.booklending.entity.Reservation">
UPDATE reservation
SET user_id = #{userId},
book_id = #{bookId},
reservation_date = #{reservationDate},
expiration_date = #{expirationDate},
status = #{status},
priority = #{priority},
updated_at = #{updatedAt}
WHERE id = #{id}
</update>

<delete id="delete" parameterType="Long">
DELETE FROM reservation WHERE id = #{id}
</delete>

<select id="selectById" resultMap="ReservationResultMap" parameterType="Long">
SELECT * FROM reservation WHERE id = #{id}
</select>

<select id="selectByUserId" resultMap="ReservationResultMap" parameterType="Long">
SELECT * FROM reservation WHERE user_id = #{userId} ORDER BY reservation_date DESC
</select>

<select id="selectByBookId" resultMap="ReservationResultMap" parameterType="Long">
SELECT * FROM reservation WHERE book_id = #{bookId} ORDER BY reservation_date ASC
</select>

<select id="selectAll" resultMap="ReservationResultMap">
SELECT * FROM reservation ORDER BY created_at DESC
</select>

<select id="selectExpired" resultMap="ReservationResultMap" parameterType="Date">
SELECT * FROM reservation WHERE status = 'ACTIVE' AND expiration_date &lt; #{currentDate} ORDER BY expiration_date ASC
</select>

<select id="selectByUserAndBook" resultMap="ReservationResultMap">
SELECT * FROM reservation WHERE user_id = #{userId} AND book_id = #{bookId} ORDER BY reservation_date DESC LIMIT 1
</select>

<select id="selectNextActiveReservation" resultMap="ReservationResultMap" parameterType="Long">
SELECT * FROM reservation WHERE book_id = #{bookId} AND status = 'ACTIVE' ORDER BY reservation_date ASC LIMIT 1
</select>
</mapper>